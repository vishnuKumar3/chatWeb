<!doctype html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
		<link rel="stylesheet" href="global.css"/>
		<title>ChatWeb</title>
		<style>
			html,body{
				height:100%;
			}
			#main{
				border:1px solid transparent;
				width:100%;
				height:100%;
				display:flex;
				flex-direction:column;
				justify-content:center;
			}
			#part1{
				width:100%;
				display:flex;
				justify-content:space-between;
				align-items:center;
				height:8%;
				padding:0px 20px;
				border:1px solid #0003;
				border-radius:0px 0px 10px 10px;
			}
			#part1 #title{
				font-size:30px;
				font-weight:500;
			}
			#part1 #profileButton{
				cursor:pointer;
				width:35px;
				height:35px;
			}
			#part2{
				height:92%;
				display:flex;
				justify-content:center;
			}
			#part2 #left{
				width:20%;
				overflow-y:scroll;
				border:1px solid #0003;
				border-top-color:transparent;
				border-radius:10px;
				height:100%;
				display:flex;
				flex-direction:column;
				align-items:flex-start;
			}
			#part2 #right{
				width:80%;
				border:1px solid transparent;
				height:100%;
			}
			#part2 #left #user{
				cursor:pointer;
				width:100%;
				border:1px solid transparent;
				border-radius:8px;
				background:#00000012;
				height:60px;
				display:flex;
				z-index:1;
				align-items:center;
				padding:5px;
				margin-bottom:5px;
			}

			#part2 #left #user:hover{
				border-left:3px solid #00fa;
				border-right:3px solid #00fa;
				transition:0.1s;
			}			
			#part2 #user img{
				z-index:0;
				width:50px;
				height:50px;
				border:1px solid transparent;
				border-radius:100%;
			}
			#part2 #user #userId{
				display:none;
			}		
			#part2 #user #name{
				z-index:0;
				font-size:20px;
				font-weight:200;
			}
			#part2 #right #header {
				height:9%;
				display:flex;
				justify-content:flex-start;
				align-items:center;
				border-bottom:1px solid #0003;				
				border-radius:5px;
				padding:5px 10px;
			}
			#part2 #right #header img{
				width:35px;
				height:35px;
				border-radius:100%;
				margin-right:10px;
			}		
			#part2 #right #header p{
				font-size:18px;
				text-transform:capitalize;
			}				
			#part2 #right #displayMsg{
				flex:1;
				display:flex;
				flex-direction:column-reverse;
				justify-content:flex-start;
				height:82%;
				border:2px solid transparent;
				overflow-y:scroll;				
			}
			#part2 #right #msgContainer{
				display:flex;
				flex-direction:column;
				height:max-content;
			}			
			#part2 #right #typeMsg{
				height:9%;
				border-top:1px solid #0003;
				padding:10px 0px 5px 10px;
				border-radius:10px;
				display:flex;
				justify-content:flex-start;
				align-items:center;
				width:100%;
			}	
			#part2 #typeMsg #msgBox{
				width:80%;
				padding:5px;
				font-size:18px;
				height:100%;
				border-radius:10px;
				border:1px solid #0005;
			}	
			#part2 #typeMsg img{
				width:35px;
				height:35px;
				cursor:pointer;
				margin-left:5%;
			}			
			#part2 #typeMsg img:hover{
				transform:scale(1.2);
				transition:0.2s linear;				
			}								
			#part2 #right #leftMsg,#part2 #right #rightMsg{
				width:100%;
				border:1px solid transparent;				
				display:flex;
				justify-content:flex-start;
				align-items:center;
				padding:8px 10px;
			}
			#part2 #right #rightMsg{
				justify-content:flex-end;
			}
			#part2 #right #msg{
				max-width:40%;
				font-size:18px;
				font-weight:300;
				padding:5px 20px;
				height:max-content;
				border:1px solid transparent;
				border-radius:10px;
				background:#00fa;
				color:white;
			} 				
			#part2 #addContact{
				display:none;
				flex-direction:column;
				padding:10px 10px 20px 10px;
				border:1px solid #0005;
				border-radius:8px;
				width:200px;
				position:fixed;
				top:0;
				right:0;	
				background:white;			
			}
			#part2 #addContact #section1{
				display:flex;
				justify-content:space-between;
				align-items:center;
				margin-bottom:10px;
			}
			#part2 #addContact #section1 img{
				width:20px;
				height:20px;
				cursor:pointer;
			}
			#part2 #addContact #section1 img:hover{
				transform:scale(1.3);
				transition:0.2s linear;
			}			
			#part2 #addContact input{
				width:100%;
				padding:2px 8px;
				font-size:15px;
				height:30px;
				border-radius:5px;
				border:1px solid #0005;	
			}		
			@keyframes contactBox{
				from{transform:scale(0.3) translate(0px,0px);display:none;opacity:0;}
				to{transform:scale(1) translate(-10px,20px);;display:flex;opacity:1;}
			}
			@keyframes contactBoxDiminish{
				to{transform:translate(0px,0px) scale(0.3);display:none;opacity:0;}
				from{transform:translate(-10px,20px) scale(1);display:flex;opacity:1;}
			}				
		</style>
	</head>
	<body>
		<div id="main">
			<div id="part1">
				<p id="title">ChatWeb</p>
				<a title="Edit Details" href="addDetails.html"><img id="profileButton" src="icons/adduser.png" /></a>
			</div>
			<div id="part2">
				<div id="left">
					<div id="user">
						<img id="dp" src="dp.png"/>
						<p id="name">Username1</p>
					</div>
				</div>
				<!--<div id="textBox">
					<input type="text">
				</div>-->
				<div id="right">
					<div id="header">
						<img src="dp.png"/>
						<p>Name</p>
					</div>
					<div id="displayMsg">
						<div id="msgContainer">
						<!--<div id="leftMsg"><p id="msg">hii,this is and this is very begining and is very beautiful and are these are very rare things</p></div>
						<div id="rightMsg"><p id="msg">hello</p></div>-->
						</div>
					</div>
					<div id="typeMsg">
						<input id="msgBox" type="text"/>
						<img title="Send" onclick="sendMsg()" src="icons/email.png"/>
						<img title="Add Contact" src="icons/adduser.png" onclick="showAddContact()"/>
					</div>				
				</div>
				<div id="addContact">
					<div id="section1">				
						<img title="Add Contact" onclick="addContact()" src="icons/adduser.png">				
						<img title="close" style="width:17px;height:17px;" src="icons/close.png" onclick="hideAddContact()"/>				
					</div>
					<input type="number" id="contact">					
				</div>
			</div>
		</div>
	</body>
	<script src="socket.io.js"></script>
	<script>

		var user=1000;
		var loaded={};
		var client="";	
		let selectedUser=0;	
		window.onload=async function(){
			user=parseInt(localStorage.getItem("userPhone"));
			loadDp();
		};
		var socket=io("http://localhost:8080");
		socket.on("connect",function(){
			socket.emit("newUser",{"phone":user});
		})		
		socket.on("disconnect",function(){
			console.log("user disconnected");
		})
		
		function sendMsg(){
			var message=document.getElementById("msgBox").value;
			document.getElementById("msgBox").value="";	
			if(message.trim().length!=0){
				socket.emit("startChat",{"sender":user,"client":client,"message":message});	
				}
			else
			alert("message box is empty");
		}
		
		socket.on("message",function(data){
			console.log(data,"HII");
			var clients={};
			clients[user]="1";
			var totalMsg="";
			if(clients[data["from"]]!=undefined){		
				//totalMsg+=`<div id="right">From:${data["from"]}<br/>Message:${data["message"]}<br/></div>`;
				totalMsg+=`<div id="rightMsg"><p id="msg">${data["msg"]}</p></div>`;
			}
			else{
				//totalMsg+=`<div id="left">From:${data["from"]}<br/>Message:${data["message"]}<br/></div>`;		
				totalMsg+=`<div id="leftMsg"><p id="msg">${data["msg"]}</p></div>`;					
			}
			loaded[client]+=totalMsg;
			document.getElementById("msgContainer").innerHTML+=totalMsg;	
			document.getElementById("displayMsg").scrollTop=0;												
			
		})			
		
		async function fetchMsg(clientTemp,index,name,dp){
			//alert(name);
			document.querySelector("#part2 #right #header p").innerHTML=name;
			document.querySelector("#part2 #right #header img").src=dp;			
			document.querySelectorAll("#part2 #left #user")[selectedUser].style.background="#00000012";					
			document.querySelectorAll("#part2 #left #user")[selectedUser].style.color="black";								
			document.querySelectorAll("#part2 #left #user")[index].style.background="#00fa";			
			document.querySelectorAll("#part2 #left #user")[index].style.color="white";						
			selectedUser=index;
			client=parseInt(clientTemp);
			//alert(client);
			if(loaded[client]!=undefined){
				document.getElementById("msgContainer").innerHTML=loaded[client];
				return null;
			}
			var ret=await fetch("http://localhost:8080/user/fetchMsg",{"method":"post","headers":{"Content-Type":"application/json"},"body":JSON.stringify({"sender":user,"client":client})});
			var res=await ret.json();
			console.log(res);
			var html="";
			res["data"].map((v)=>{
				if(v["from"]==user)
					html+=`<div id="rightMsg"><p id="msg">${v["msg"]}</p></div>`
				else
					html+=`<div id="leftMsg"><p id="msg">${v["msg"]}</p></div>`
			})
			loaded[client]=html;
			document.getElementById("msgContainer").innerHTML=loaded[client];						
		}
		
		
		
		async function loadDp(){
			var res=await fetch("http://localhost:8080/user/fetchContacts",{"method":"post","headers":{"Content-Type":"application/json"},"body":JSON.stringify({"user":user})});
			console.log(res);
			var ret=await res.json();
			console.log(ret);
			var usersDisplay=""
			ret["data"].map((user,index)=>{
				usersDisplay+=`<div onclick='fetchMsg(${user["_id"]},${index},"${user["name"]}","${user['dp']}")' id="user">
							<img id="dp" src="${user["dp"]}"/>&nbsp
							<p id="name">${user["name"]}</p>
						</div>`
			})
			document.querySelector("#part2 #left").innerHTML=usersDisplay;
			
		}
		
		async function addContact(){
			var contact= document.getElementById("contact").value;
			var data={"user":user,"phone":parseInt(contact)}
			var ret=await fetch("http://localhost:8080/user/addContact",{"method":"post","headers":{"Content-Type":"application/json"},"body":JSON.stringify(data)});
			var res=await ret.json();
			if(res["status"]){alert(res["msg"]);loadDp();}
			else alert(res["msg"]);
			document.getElementById("contact").value="";
		}
		
		function showAddContact(){
			document.getElementById("addContact").style.display="flex";		
			document.getElementById("addContact").style.animation="contactBox 0.5s linear both";
		}
		function hideAddContact(){
			document.getElementById("addContact").style.animation="contactBoxDiminish 0.5s linear both";
		}		
	</script>
</html>

